# ------------------------------------------------------------------------
# OWASP CRS Plugin
# Copyright (c) 2021-2024 CRS project. All rights reserved.
#
# The OWASP CRS plugins are distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

SecRule TX:dokuwiki-rule-exclusions-plugin_enabled "@eq 0" "id:9509099,phase:1,pass,nolog,ctl:ruleRemoveById=9509100-9509999"
SecRule REQUEST_FILENAME "@rx (?:/doku.php|/lib/exe/ajax.php)$" \
    "id:9509100,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'dokuwiki-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "t:none,\
        chain"
        SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ "@rx ^[%a-zA-Z0-9_-]+" \
            "t:none,\
            ctl:ruleRemoveTargetByTag=attack-protocol;ARGS:wikitext,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:wikitext,\
            ctl:ruleRemoveTargetByTag=attack-protocol;ARGS:suffix,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:suffix,\
            ctl:ruleRemoveTargetByTag=attack-protocol;ARGS:prefix,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:prefix,\
            ctl:ruleRemoveTargetById=930100-930110;REQUEST_BODY"
SecRule REQUEST_FILENAME "@endsWith /lib/exe/ajax.php" \
    "id:9509110,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    noauditlog,\
    ver:'dokuwiki-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "t:none,\
        chain"
        SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ "@rx ^[%a-zA-Z0-9_-]+" \
            "t:none,\
            setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |application/octet-stream|'"
SecRule REQUEST_FILENAME "@endsWith /doku.php" \
    "id:9509130,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    noauditlog,\
    ver:'dokuwiki-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:do "@streq index" \
        "t:none,\
        chain"
        SecRule &ARGS:do "@eq 1" \
            "t:none,\
            ctl:ruleRemoveById=951240,\
            ctl:ruleRemoveById=953110"
SecRule REQUEST_FILENAME "@endsWith /doku.php" \
    "id:9509200,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    noauditlog,\
    ver:'dokuwiki-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:do "@streq login" \
        "t:none,\
        chain"
        SecRule &ARGS:do "@eq 1" \
            "t:none,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:p"
SecRule ARGS_GET:do "!@streq admin" \
    "id:9509300,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'dokuwiki-rule-exclusions-plugin/1.0.0',\
    skipAfter:END-DOKUWIKI-ADMIN"
SecRule ARGS:do "!@streq admin" \
    "id:9509310,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    ver:'dokuwiki-rule-exclusions-plugin/1.0.0',\
    skipAfter:END-DOKUWIKI-ADMIN"
SecRule REQUEST_FILENAME "@endsWith /doku.php" \
    "id:9509320,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    noauditlog,\
    ver:'dokuwiki-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:do "@streq login" \
        "t:none,\
        chain"
        SecRule &ARGS:do "@eq 1" \
            "t:none,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:pass1,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:pass1-text,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:pass2"
SecRule REQUEST_FILENAME "@endsWith /doku.php" \
    "id:9509370,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    noauditlog,\
    ver:'dokuwiki-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:page "@streq config" \
        "t:none,\
        chain"
        SecRule &ARGS:page "@eq 1" \
            "t:none,\
            chain"
            SecRule REQUEST_METHOD "@streq POST" \
                "t:none,\
                chain"
                SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ "@rx ^[%a-zA-Z0-9_-]+" \
                    "t:none,\
                    ctl:ruleRemoveTargetById=920230;ARGS:config[dformat],\
                    ctl:ruleRemoveTargetById=942200;ARGS:config[tagline],\
                    ctl:ruleRemoveTargetById=942430;ARGS:config[hidepages],\
                    ctl:ruleRemoveTargetById=942430-942440;ARGS:config[signature]"
SecRule REQUEST_FILENAME "@endsWith /doku.php" \
    "id:9509380,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    noauditlog,\
    ver:'dokuwiki-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:page "@streq config" \
        "t:none,\
        chain"
        SecRule &ARGS:page "@eq 1" \
            "t:none,\
            chain"
            SecRule REQUEST_COOKIES:/S?DW[a-f0-9]+/ "@rx ^[%a-zA-Z0-9_-]+" \
                "t:none,\
                ctl:ruleRemoveById=951240,\
                ctl:ruleRemoveById=953110"
SecMarker "END-DOKUWIKI-ADMIN"
